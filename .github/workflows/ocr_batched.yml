ame: Bethel OCR & Extraction (Batched via Google Drive)

on:
  workflow_dispatch:
    inputs:
      total_pages:
        description: "Total number of pages available (e.g. 928)"
        required: true
        default: "928"
      batch_size:
        description: "How many pages to process per batch"
        required: true
        default: "20"
      start_page:
        description: "First page to process (leave blank for 1)"
        required: false
        default: ""
      end_page:
        description: "Last page to process (leave blank for total_pages)"
        required: false
        default: ""
      dry_run:
        description: "Dry run (no OpenAI calls, just logging + stub JSON)?"
        required: true
        default: "false"

jobs:
  run-ocr-batched:
    runs-on: ubuntu-latest
    timeout-minutes: 1440  # up to 24 hours if needed

    env:
      # Secrets
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GDRIVE_FILE_ID: ${{ secrets.GDRIVE_FILE_ID }}

      # Directories / files (must match ocr_script.py)
      PAGES_DIR: pages
      OUTPUT_JSONL: ocr_all_pages.jsonl
      PER_PAGE_DIR: per_page
      OCR_OUTPUT_DIR: ocr_output
      COMPLEXITY_LOG: page_complexity.csv

      # Models
      VISION_MODEL: gpt-4o
      TEXT_MODEL: gpt-4o-mini

      # Concurrency
      MAX_WORKERS: "4"

      # Strip / density defaults
      USE_STRIPS: "0"
      AUTO_STRIP_MODE: "1"
      STRIPS_PER_PAGE: "6"
      MAX_STRIPS_PER_PAGE: "8"
      STRIP_OVERLAP: "20"

      EASY_INK_THRESHOLD: "0.05"
      DENSE_INK_THRESHOLD: "0.12"
      SUPER_DENSE_INK_THRESHOLD: "0.18"

      MAX_LONG_DIM: "2048"
      MAX_TOTAL_PIXELS: "20000000"

      # Inputs wired into env for the batch shell logic
      WF_TOTAL_PAGES: ${{ github.event.inputs.total_pages }}
      WF_BATCH_SIZE: ${{ github.event.inputs.batch_size }}
      WF_START_PAGE: ${{ github.event.inputs.start_page }}
      WF_END_PAGE: ${{ github.event.inputs.end_page }}
      DRY_RUN: ${{ github.event.inputs.dry_run }}

      # Local zip path
      PAGES_ZIP_PATH: pages_all.zip

    steps:
      - name: Checkout repository (no LFS)
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (including gdown)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install gdown

      - name: Download pages archive from Google Drive
        run: |
          set -euo pipefail
          if [ -z "${GDRIVE_FILE_ID:-}" ]; then
            echo "ERROR: GDRIVE_FILE_ID secret is not set."
            exit 1
          fi

          echo "Downloading pages archive from Google Drive (file ID: $GDRIVE_FILE_ID)..."
          gdown --id "$GDRIVE_FILE_ID" -O "$PAGES_ZIP_PATH"
          ls -lh "$PAGES_ZIP_PATH"

      - name: Run OCR in batches
        shell: bash
        run: |
          set -euo pipefail

          TOTAL_PAGES="${WF_TOTAL_PAGES:-0}"
          BATCH_SIZE="${WF_BATCH_SIZE:-20}"
          START_IN="${WF_START_PAGE:-}"
          END_IN="${WF_END_PAGE:-}"
          DRY_RUN_VAL="${DRY_RUN:-false}"

          echo "Dry run mode (env DRY_RUN): $DRY_RUN_VAL"
          echo "Pages zip path: $PAGES_ZIP_PATH"

          if [ ! -f "$PAGES_ZIP_PATH" ]; then
            echo "ERROR: Pages zip '$PAGES_ZIP_PATH' not found."
            exit 1
          fi

          if [ "$TOTAL_PAGES" -le 0 ]; then
            echo "ERROR: WF_TOTAL_PAGES must be > 0 (got '$TOTAL_PAGES')."
            exit 1
          fi

          # Resolve start / end with defaults
          if [ -z "$START_IN" ]; then
            START=1
          else
            START="$START_IN"
          fi

          if [ -z "$END_IN" ]; then
            END="$TOTAL_PAGES"
          else
            END="$END_IN"
          fi

          echo "Batch OCR run: pages $START to $END (total pages=$TOTAL_PAGES, batch size=$BATCH_SIZE)"

          if [ "$START" -lt 1 ] || [ "$END" -lt "$START" ] || [ "$END" -gt "$TOTAL_PAGES" ]; then
            echo "ERROR: invalid START/END range: START=$START, END=$END, TOTAL_PAGES=$TOTAL_PAGES"
            exit 1
          fi

          mkdir -p "$PAGES_DIR"

          CUR="$START"
          while [ "$CUR" -le "$END" ]; do
            BATCH_START="$CUR"
            BATCH_END=$((CUR + BATCH_SIZE - 1))
            if [ "$BATCH_END" -gt "$END" ]; then
              BATCH_END="$END"
            fi

            echo "---------------------------------------------"
            echo "Processing batch: $BATCH_START to $BATCH_END"
            echo "---------------------------------------------"

            # Build list of files for this batch
            INCLUDE_FILES=()
            for i in $(seq "$BATCH_START" "$BATCH_END"); do
              INCLUDE_FILES+=("pages/page-$i.png")
            done

            echo "Extracting files from zip for batch:"
            printf '  %s\n' "${INCLUDE_FILES[@]}"

            # Extract only the needed files for this batch
            unzip -q "$PAGES_ZIP_PATH" "${INCLUDE_FILES[@]}"

            echo "Running OCR script for batch $BATCH_STARTâ€“$BATCH_END..."
            START_PAGE="$BATCH_START" END_PAGE="$BATCH_END" python ocr_script.py

            echo "Cleaning batch PNGs to free disk..."
            rm -f "${INCLUDE_FILES[@]}" || true

            CUR=$((BATCH_END + 1))
          done

          echo "All batches complete."

      - name: Upload OCR outputs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bethel-ocr-batched-output
          path: |
            ocr_all_pages.jsonl
            ocr_output/
            per_page/
            page_complexity.csv
          if-no-files-found: warn
